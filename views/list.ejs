<!-- ejs == html ê°™ì´ ì‘ì„± -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íƒ€ì´í‹€</title>
    <%- include('tiles/head.ejs') %>
</head>
<body class="grey-bg">
    <!-- includeë¡œ ìƒë‹¨ë°” ê°€ì ¸ì˜¤ê¸° ( - = ë°ì´í„° í‘œì¶œ ì°¨ì´ì ì€ =ëŠ” html escapeë˜ì„œ ë§Œë“¤ì–´ì§€ê³  -ëŠ” htmlì´ escapeë˜ì§€ ì•Šê³  ê°€ì ¸ì˜´) -->
    <%- include('tiles/nav.ejs') %>
    <div class="white-bg">
      <!-- ì„œë²„ì‚¬ì´ë“œ ëœë”ë§ (í´ë¼ì´ì–¸íŠ¸ì‚¬ì´ë“œ ë Œë”ë§ë„ ìˆìŒ)-->
      <!-- <div class="list-box">
        <h4><%=ê¸€ëª©ë¡[0].title%></h4> 
        <p><%=ê¸€ëª©ë¡[0].content%></p>
      </div>
      <div class="list-box">
        <h4><%=ê¸€ëª©ë¡[1].title%></h4>
        <p><%=ê¸€ëª©ë¡[1].content%></p>
      </div> -->
      <!-- ejs ë°˜ë³µë¬¸ -->
      <div id="listBody">
        <% for(let i=0;i < ê¸€ëª©ë¡.length; i++){ %>
        <div class="list-box">
          <h4>
            <a class="title" href="/detail/<%=ê¸€ëª©ë¡[i]._id%>"><%=ê¸€ëª©ë¡[i].title%></a>
            <span class="delete">ğŸ—‘ï¸</span>
          </h4>
          <p><%=ê¸€ëª©ë¡[i].content%></p>
          
        </div>
        <% } %>
      </div>
      <a class="btn btn-primary" href="/write">ê¸€ì“°ê¸°</a>
    </div> 
  </body>
</html>

<script>

  /** 
   * ë°ì´í„° ëª©ë¡ ìš”ì²­
  */
  let getListData = function(){
    fetch('/listData',{
      method:"GET",
      headers:{"Content-Type":"application/json"}
    }).then((response)=>response.json())
    .then((data)=>{
      let initText = ''
      if(data.isSucceed){
        const listBody = document.getElementById("listBody")
        let result = data.result
        for(idx in result){
          initText = initText + '<div class="list-box">\n'
          initText = initText + ' <h4>\n'
          initText = initText + '   <a class="title" href="/detail/'+result[idx]._id+'">'+result[idx].title+'</a>\n'
          initText = initText + '   <span class="delete">ğŸ—‘ï¸</span>\n'
          initText = initText + ' </h4>\n'
          initText = initText + ' <p>'+result[idx].content+'</p>\n'
          initText = initText + '</div>\n'
        }
        listBody.textContent = ''
        listBody.innerHTML = initText
      }else{
        console.log(data.msg)
      }
    }).catch(e =>{
      console.log("error :"+ e)
    })
  }

  document.querySelectorAll('.delete').forEach((col) =>{
      col.addEventListener('click', (event) =>{
        let arg = event.currentTarget.parentNode.querySelector('.title').getAttribute('href')
        let id = arg.substring(arg.lastIndexOf('/')+1)
        fetch('/delete',{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({id:id})
        })
        .then((response)=>response.json())
        .then((data)=>{
          if(data.isSucceed){
            console.log(data.msg)
            getListData()
          }else{
            console.log(data.msg)
          }
        })
        .catch((e)=>{
          console.log("error :"+ e)
        })
        
      })
  })
</script>
<!-- ejs == html ê°™ì´ ì‘ì„± -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª©ë¡</title>
    <%- include('navigation/head.ejs') %>
</head>
<body class="grey-bg">
    <!-- includeë¡œ ìƒë‹¨ë°” ê°€ì ¸ì˜¤ê¸° ( - = ë°ì´í„° í‘œì¶œ ì°¨ì´ì ì€ =ëŠ” html escapeë˜ì„œ ë§Œë“¤ì–´ì§€ê³  -ëŠ” htmlì´ escapeë˜ì§€ ì•Šê³  ê°€ì ¸ì˜´) -->
    <%- include('navigation/nav.ejs') %>
    <div class="white-bg">
      <div class="input-group me-3"><input type="text" id="searchWord" value="<%=searchWord%>"><a class="btn btn-primary" id="searchBtn">ê²€ìƒ‰</a></div>
      <!-- ì„œë²„ì‚¬ì´ë“œ ëœë”ë§ (í´ë¼ì´ì–¸íŠ¸ì‚¬ì´ë“œ ë Œë”ë§ë„ ìˆìŒ)-->
      <!-- ejs ë°˜ë³µë¬¸ -->
      <div id="listBody">
        <% for(let i=0;i < ê¸€ëª©ë¡.length; i++){ %>
        <div class="list-box">
          <h4>
            <a class="title" href="/detail/<%=ê¸€ëª©ë¡[i]._id%>"><%=ê¸€ëª©ë¡[i].title%></a>
            <% if(String(ê¸€ëª©ë¡[i].user) == String(user._id)) { %>
              <span class="delete" data-id="<%=ê¸€ëª©ë¡[i]._id%>">ğŸ—‘ï¸</span>
            <% } %>
            <% if((ê¸€ëª©ë¡[i].user != null)){ %>
              <a class="" href="/chat/request/<%=ê¸€ëª©ë¡[i]._id%>">ì±„íŒ…ìš”ì²­</a>
            <% } %>
          </h4>
        </div>
        <% } %>
      </div>
      <a class="btn btn-primary" href="/board/write">ê¸€ì“°ê¸°</a>
    </div>
    <ul id="pagination" class="pagination">
      <% let searchUrl = '?searchWord=' + searchWord;
        if(searchWord == null || searchWord == '') {
          searchUrl = ''; 
        }%>
      <% if(pageInfo.first) { %>
        <li><a href="/list/1<%=searchUrl%>">&#171;</a></li>
      <% } %>
      <% if(pageInfo.prev) { %>
        <li><a href="/list/<%=pageInfo.prev%><%=searchUrl%>">&lt;</a></li>
      <% } %>
      <% for(let i=pageInfo.startPage;i<=pageInfo.endPage;i++){ %>
        <% if(i == pageInfo.currentPage) { %>
          <li><a class="active"><%=i%></a></li>
        <% }else{ %>
          <li><a href="/list/<%=i %><%=searchUrl%>"><%=i%></a></li>
        <% } %>
      <% } %>
      <% if(pageInfo.next) { %>
        <li><a href="/list/<%=pageInfo.next%><%=searchUrl%>">&gt;</a></li>
      <% } %>
      <% if(pageInfo.last) { %>
        <li><a href="/list/<%=pageInfo.last%><%=searchUrl%>">&#187;</a></li>
      <% } %>
    </ul>
    <!-- SSEì—°ê²°
      SSEì—°ê²°ì„ ì›í•˜ë©´
      new EventSource('/URL')
      ì„œë²„ì—ì„œ event ë¡œ ë³´ë‚´ëŠ” keyê°’ì´ ì˜ˆë¡œ msgë©´ ì—¬ê¸°ì„œë„ msgë¡œ ë°›ì•„ì„œ í™•ì¸
    -->
    <script> 
      let eventSource = new EventSource('/stream/list')
      eventSource.addEventListener('msg',function(e){
        console.log(e.data);
        let objData = JSON.parse(e.data) // array/objectë¡œ ë³€ê²½
        let view = '<div class="list-box">';
        view = view + '<h4>';
        view = view + '<a class="title" href="/detail/'+objData._id+'">'+objData.title+'</a>'
        if(String(e.data.user) == String('<%=user._id%>')){
          view = view + `<span class="delete" data-id="${objData._id}">ğŸ—‘ï¸</span>`
        }
        if(e.data.user != null){
          view = view + `<a class="" href="/chat/request/${objData._id}">ì±„íŒ…ìš”ì²­</a>`
        }
        view = view + '</h4>'
        view = view + '</div>'
        document.querySelector('.white-bg').insertAdjacentElement('afterbegin',view);
      })
    </script>
  </body>
</html>
<!-- <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> -->
<script>
  /* // axios ì˜ˆì‹œ
    axios.get('/URL',{
      params:{
        ID : 12345
      }
    }).then((response) =>{
      console.log(r)
    }).catch((e)=>{
      console.log("Error:", e.response.data)
      console.log("Error:", e.response.status)
      console.log("Error:", e.response.headers)
    })

    axios({
      method:'GET',
      url:'/URL',
      data: {
        data1 : 'data1',
        data2 : 'data2'
      }
      //,responseType: 'stream' //ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
    }).then((response) => { //then í•œë²ˆë§Œ ì¨ë„ ë¨
      console.log(r)
      //response.data.pipe(fs.createWriteStream('a.jpg'))
    }).catch((e) = > {
      console.log("Error:", e.response.data)
      console.log("Error:", e.response.status)
      console.log("Error:", e.response.headers)
      // ì—ëŸ¬ì‹œ ì‹¤í–‰ ì½”ë“œ
    });
  */
  /** 
   * ë°ì´í„° ëª©ë¡ ìš”ì²­
  */
  let getListData = function(page,searchWord){
    fetch('/listData?page='+page+'&searchWord='+searchWord,{
      method:"GET",
      headers:{"Content-Type":"application/json"}
    }).then((response)=>response.json())
    .then((data)=>{
      if(data.isSucceed){
        // ë°ì´í„° ì²˜ë¦¬
        let initText = '';
        const listBody = document.getElementById("listBody");
        const pageBody = document.getElementById("pagination");
        let result = data.result;
        for(idx in result){
          initText = initText + '<div class="list-box">\n';
          initText = initText + ' <h4>\n';
          initText = initText + '   <a class="title" href="/detail/'+result[idx]._id+'">'+result[idx].title+'</a>\n';
          if(result[idx].del){
            initText = initText + '   <span class="delete">ğŸ—‘ï¸</span>\n';
          } 
          initText = initText + ' </h4>\n';
          initText = initText + '</div>\n';
        }
        // í˜ì´ì§• ì²˜ë¦¬
        let pageText = '';
        let pageInfo = data.pageInfo;
        let searchUrl = '';
        if(searchWord != null && searchWord != "") searchUrl='?searchWord='+searchWord;
        if(pageInfo.first){
          pageText = pageText + '<li><a href="/list/1'+searchUrl+'">&#171;</a></li>\n';
        }
        if(pageInfo.prev){
          pageText = pageText + '<li><a href="/list/'+(pageInfo.prev)+searchUrl+'">&lt;</a></li>\n';
        }
        for(let i=pageInfo.startPage;i<=pageInfo.endPage;i++){
          if(i == pageInfo.currentPage){
            pageText = pageText + '<li><a class="active">'+i+'</a></li>\n';
          }else{
            pageText = pageText + '<li><a href="/list/'+i+searchUrl+'">'+i+'</a></li>\n';
          }
        }
        if(pageInfo.next){
          pageText = pageText + '<li><a href="/list/'+(pageInfo.next)+searchUrl+'">&lt;</a></li>\n';
        }
        if(pageInfo.last){
          pageText = pageText + '<li><a href="/list/'+pageInfo.last+searchUrl+'">&#187;</a></li>\n';
        }

        listBody.textContent = '';
        listBody.innerHTML = initText;
        pageBody.textContent = '';
        pageBody.innerHTML = pageText;
      }else{
        console.log(data.msg);
      }
    }).catch(e =>{
      console.log("error :"+ e);
    })
  }

  // ì‚­ì œ
  document.querySelectorAll('.delete').forEach((col) =>{
      col.addEventListener('click', (event) =>{
        let id = event.target.dataset.id;
        fetch('/board/delete',{
          method:"DELETE",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({id:id})
        })
        // .then((response) => response.text())
        // .then((text) => {console.log(text)})
        .then((response)=>response.json())
        .then((data)=>{
          if(data.isSucceed){
            console.log(data.msg)
            // event.target.parentElement.parentElement.style.display = 'none'
            let searchWord = document.getElementById("searchWord").value;
            let page = document.getElementById("pagination").getElementsByClassName("active")[0].textContent
            getListData(page,searchWord);
          }else{
            console.log(data.msg)
          }
        })
        .catch((e)=>{
          console.log("error :"+ e)
        });
      });
  });

  // ê²€ìƒ‰
  document.getElementById("searchBtn").addEventListener('click',(event)=>{
    let page = document.getElementById("pagination").getElementsByClassName("active")[0].textContent
    let searchWord = document.getElementById("searchWord").value;
    //getListData(1,searchWord);
    location.href = '/list/'+page+'?searchWord='+searchWord;
  })
</script>

<!-- ejs == html Í∞ôÏù¥ ÏûëÏÑ± -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î™©Î°ù</title>
    <%- include('tiles/head.ejs') %>
</head>
<body class="grey-bg">
    <!-- includeÎ°ú ÏÉÅÎã®Î∞î Í∞ÄÏ†∏Ïò§Í∏∞ ( - = Îç∞Ïù¥ÌÑ∞ ÌëúÏ∂ú Ï∞®Ïù¥Ï†êÏùÄ =Îäî html escapeÎêòÏÑú ÎßåÎì§Ïñ¥ÏßÄÍ≥† -Îäî htmlÏù¥ escapeÎêòÏßÄ ÏïäÍ≥† Í∞ÄÏ†∏Ïò¥) -->
    <%- include('tiles/nav.ejs') %>
    <div class="white-bg">
      <!-- ÏÑúÎ≤ÑÏÇ¨Ïù¥Îìú ÎûúÎçîÎßÅ (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏÇ¨Ïù¥Îìú Î†åÎçîÎßÅÎèÑ ÏûàÏùå)-->
      <!-- ejs Î∞òÎ≥µÎ¨∏ -->
      <div id="listBody">
        <% for(let i=0;i < Í∏ÄÎ™©Î°ù.length; i++){ %>
        <div class="list-box">
          <h4>
            <a class="title" href="/detail/<%=Í∏ÄÎ™©Î°ù[i]._id%>"><%=Í∏ÄÎ™©Î°ù[i].title%></a>
            <span class="delete" data-id="<%=Í∏ÄÎ™©Î°ù[i]._id%>">üóëÔ∏è</span>
          </h4>
        </div>
        <% } %>
      </div>
      <a class="btn btn-primary" href="/write">Í∏ÄÏì∞Í∏∞</a>
    </div>
    <ul id="pagination" class="pagination">
      <% if(pageInfo.first) { %>
        <li><a href="/list/1">&#171;</a></li>
      <% } %>
      <% if(pageInfo.prev) { %>
        <li><a href="/list/<%=pageInfo.prev%>">&lt;</a></li>
      <% } %>
      <% for(let i=pageInfo.startPage;i<=pageInfo.endPage;i++){ %>
        <% if(i == pageInfo.currentPage) { %>
          <li><a class="active"><%=i%></a></li>
        <% }else{ %>
          <li><a href="/list/<%=i %>"><%=i%></a></li>
        <% } %>
      <% } %>
      <% if(pageInfo.next) { %>
        <li><a href="/list/<%=pageInfo.next%>">&gt;</a></li>
      <% } %>
      <% if(pageInfo.last) { %>
        <li><a href="/list/<%=pageInfo.last%>">&#187;</a></li>
      <% } %>
    </ul>
  </body>
</html>
<!-- <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script> -->
<script>
  /*
    axios.get('/URL',{
      params:{
        ID : 12345
      }
    }).then((response) =>{
      console.log(r)
    }).catch((e)=>{
      console.log("Error:", e.response.data)
      console.log("Error:", e.response.status)
      console.log("Error:", e.response.headers)
    })

    axios({
      method:'GET',
      url:'/URL',
      data: {
        data1 : 'data1',
        data2 : 'data2'
      }
      //,responseType: 'stream' //Ïù¥ÎØ∏ÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
    }).then((response) => { //then ÌïúÎ≤àÎßå Ïç®ÎèÑ Îê®
      console.log(r)
      //response.data.pipe(fs.createWriteStream('a.jpg'))
    }).catch((e) = > {
      console.log("Error:", e.response.data)
      console.log("Error:", e.response.status)
      console.log("Error:", e.response.headers)
      // ÏóêÎü¨Ïãú Ïã§Ìñâ ÏΩîÎìú
    });
  */
  /** 
   * Îç∞Ïù¥ÌÑ∞ Î™©Î°ù ÏöîÏ≤≠
  */
  let getListData = function(){
    let page = document.getElementById("pagination").getElementsByClassName("active")[0].text
    fetch('/listData?page='+page,{
      method:"GET",
      headers:{"Content-Type":"application/json"}
    }).then((response)=>response.json())
    .then((data)=>{
      if(data.isSucceed){
        // Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
        let initText = '';
        const listBody = document.getElementById("listBody");
        const pageBody = document.getElementById("pagination");
        let result = data.result;
        for(idx in result){
          initText = initText + '<div class="list-box">\n';
          initText = initText + ' <h4>\n';
          initText = initText + '   <a class="title" href="/detail/'+result[idx]._id+'">'+result[idx].title+'</a>\n';
          initText = initText + '   <span class="delete">üóëÔ∏è</span>\n';
          initText = initText + ' </h4>\n';
          initText = initText + '</div>\n';
        }

        // ÌéòÏù¥Ïßï Ï≤òÎ¶¨
        let pageText = '';
        let pageInfo = data.pageInfo;
        if(pageInfo.first){
          pageText = pageText + '<li><a href="/list/1">&#171;</a></li>\n';
        }
        if(pageInfo.prev){
          pageText = pageText + '<li><a href="/list/'+(pageInfo.prev)+'">&lt;</a></li>\n';
        }
        for(let i=pageInfo.startPage;i<=pageInfo.endPage;i++){
          if(i == pageInfo.currentPage){
            pageText = pageText + '<li><a class="active">'+i+'</a></li>\n';
          }else{
            pageText = pageText + '<li><a href="/list/'+i+'">'+i+'</a></li>\n';
          }
        }
        if(pageInfo.next){
          pageText = pageText + '<li><a href="/list/'+(pageInfo.next)+'">&lt;</a></li>\n';
        }
        if(pageInfo.last){
          pageText = pageText + '<li><a href="/list/'+pageInfo.last+'">&#187;</a></li>\n';
        }

        listBody.textContent = '';
        listBody.innerHTML = initText;
        pageBody.textContent = '';
        pageBody.innerHTML = pageText;
      }else{
        console.log(data.msg);
      }
    }).catch(e =>{
      console.log("error :"+ e);
    })
  }

  document.querySelectorAll('.delete').forEach((col) =>{
      col.addEventListener('click', (event) =>{
        let id = event.target.dataset.id;
        fetch('/delete',{
          method:"DELETE",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({id:id})
        })
        // .then((response) => response.text())
        // .then((text) => {console.log(text)})
        .then((response)=>response.json())
        .then((data)=>{
          if(data.isSucceed){
            console.log(data.msg)
            // event.target.parentElement.parentElement.style.display = 'none'
            getListData()
          }else{
            console.log(data.msg)
          }
        })
        .catch((e)=>{
          console.log("error :"+ e)
        });
      });
  });
</script>
